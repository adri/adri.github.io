{"componentChunkName":"component---plugins-gatsby-theme-brain-src-templates-brain-js","path":"/notes/run-php-on-arm-based-aws-eks/","result":{"data":{"brainNote":{"slug":"run-php-on-arm-based-aws-eks","title":"Run PHP on ARM based AWS EKS","inboundReferenceNotes":[{"title":"Site Reliability Engineering","slug":"site-reliability-engineering"}],"inboundReferences":["site-reliability-engineering"],"childMdx":{"body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"Amazon has published a blog post \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://aws.amazon.com/blogs/compute/improving-performance-of-php-for-arm64-and-impact-on-amazon-ec2-m6g-instances/\",\n    \"target\": \"_blank\",\n    \"rel\": \"nofollow noopener noreferrer\"\n  }), \"Improving performance of PHP for Arm64 and impact on AWS Graviton2 based EC2 instances\"), \" that shows 20% cheaper ARM based instances with better performance.\"), mdx(\"h3\", null, \"ARM\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"ARM is a company that develops and sells the ARM processor architecture. \"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"ARM uses \", mdx(\"strong\", {\n    parentName: \"li\"\n  }, \"RISC\"), \" (reduced instruction set computing)\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Intel and AMD use \", mdx(\"strong\", {\n    parentName: \"li\"\n  }, \"CISC\"), \" (complex instruction set computing)\")), mdx(\"h3\", null, \"RISC vs CISC example\"), mdx(\"p\", null, \"A comparison of the pros and cons between the two approaches:\"), mdx(\"table\", null, mdx(\"thead\", {\n    parentName: \"table\"\n  }, mdx(\"tr\", {\n    parentName: \"thead\"\n  }, mdx(\"th\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"RISC\"), mdx(\"th\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"CISC\"))), mdx(\"tbody\", {\n    parentName: \"table\"\n  }, mdx(\"tr\", {\n    parentName: \"tbody\"\n  }, mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Focus on software\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Focus on hardware\")), mdx(\"tr\", {\n    parentName: \"tbody\"\n  }, mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Simple instructions (single-clock)\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Complex  instructions (multi-clock)\")), mdx(\"tr\", {\n    parentName: \"tbody\"\n  }, mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Large assembly code size\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Small assembly code size\")), mdx(\"tr\", {\n    parentName: \"tbody\"\n  }, mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Lower power usage\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Higher power usage\")), mdx(\"tr\", {\n    parentName: \"tbody\"\n  }, mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Slower compile times\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Faster compile times\")))), mdx(\"p\", null, \"Many years ago the RAM price was very high, so CISC had advantages because it uses less instructions. The price of RAM has decreased and compilers have become smarter making RISC the better architecture now.\"), mdx(\"h3\", null, \"RISC vs CISC example\"), mdx(\"p\", null, \"Some background on CPU architecture to understand the trade-offs between the two.\"), mdx(\"p\", null, \"Example:\"), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"a = a * b\")), mdx(\"p\", null, \"RISC uses only basic commands, leading to many instructions:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-asm6502\"\n  }), \"LOAD A, 2:3  ; `2:3` is the where the value `a` is stored\\nLOAD B, 5:2  ; `5:2` is the where the value `b` is stored\\nPROD A, B    ; multiply \\nSTORE 2:3, A ; store back in `a`\\n\")), mdx(\"p\", null, \"CISC uses complex commands that are implemented in hardware:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-asm6502\"\n  }), \"MULT 2:3, 5:2 ; all in one instruction\\n\")), mdx(\"h3\", null, \"Why isn't RISC the standard?\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Missing software support (Windows was designed for CISC)\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Little commercial interest meant less chips produced and higher prices for ARM based chips\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Intel did a lot of work to make CISC good\")), mdx(\"h3\", null, \"Cloud providers\"), mdx(\"p\", null, \"On AWS a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"m6g.4xlarge\"), \" costs 20% less than a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"m5.4xlarge\"), \" and is up to 40% faster. \"), mdx(\"h3\", null, \"Steps to run PHP on ARM on AWS EKS\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Server needs to run on ARM in AWS EKS\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Kubernetes tools needs to run on ARM in AWS EKS\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Software needs to compile to ARM \"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Container needs to be built to ARM on CI\")), mdx(\"h3\", null, \"Findings\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"New Relic doesn't have ARM builds:\", mdx(\"br\", {\n    parentName: \"li\"\n  }), mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://discuss.newrelic.com/t/feature-request-arm-architecture-support/23244/11\",\n    \"target\": \"_blank\",\n    \"rel\": \"nofollow noopener noreferrer\"\n  }), \"Vote for the feature here\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"CircleCI doesn't have ARM support. But images can be built via \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"docker buildx\"), \". That's slow because it's emulated but at least it works\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Most things seem to be available on ARM!\")), mdx(\"h3\", null, \"Use AWS EKS AMI with ARM\"), mdx(\"p\", null, \"A AWS EKS AMI image can be retrieved using this command:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {}), \"aws ssm get-parameter --name /aws/service/eks/optimized-ami/1.16/amazon-linux-2-arm64/recommended/image_id --region eu-west-1 --query \\\"Parameter.Value\\\" --output text\\n\")), mdx(\"p\", null, \"A node group with that image needs to be added. Using the option\", mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"--register-with-taints=dedicated=arm64:NoSchedule\"), \" is recommended so no pods are scheduled on these nodes. \"), mdx(\"p\", null, \"When running node groups with x86 and arm64 containers at the same time, the Kubernetes tools like kube-proxy and Amazon VPC CNI Plugin need to be deployed on the arm64 nodes. The \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://docs.aws.amazon.com/eks/latest/userguide/arm-support.html#enable-arm-support\",\n    \"target\": \"_blank\",\n    \"rel\": \"nofollow noopener noreferrer\"\n  }), \"AWS guide to enable ARM support\"), \" has all YAML definitions. The names and labels need to be changed to not conflict with the existing x86 versions. This step might be skipped in the future when the images can support multiple architectures. \"), mdx(\"p\", null, \"Pods can be given a toleration and affinity to be scheduled on an ARM node:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-yaml\"\n  }), \"  tolerations:\\n    - effect: NoSchedule\\n      key: dedicated\\n      operator: Equal\\n      value: arm64\\n  affinity:\\n    nodeAffinity:\\n      requiredDuringSchedulingIgnoredDuringExecution:\\n        nodeSelectorTerms:\\n         - matchExpressions:\\n           - key: \\\"kubernetes.io/os\\\"\\n             operator: In\\n             values:\\n              - linux\\n           - key: \\\"kubernetes.io/arch\\\"\\n             operator: In\\n             values:\\n              - arm64\\n           - key: \\\"eks.amazonaws.com/compute-type\\\"\\n             operator: NotIn\\n             values:\\n               - fargate    \\n\")), mdx(\"h3\", null, \"Build docker container\"), mdx(\"p\", null, \"To build a container that supports multiple architectures:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Use docker edge version\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Create a new builder\"), mdx(\"pre\", {\n    parentName: \"li\"\n  }, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"docker buildx create --name mybuilder\\n\"))), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Use the new builder\", mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", \"Build images for x86 and arm64 architectures:\"), mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Base image:\"), mdx(\"pre\", {\n    parentName: \"li\"\n  }, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {}), \"docker buildx build --platform linux/amd64,linux/arm64 -t adri/test:base-arm -f etc/php7-fpm/Dockerfile.base --push .\\n\")), mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Main image:\"), mdx(\"pre\", {\n    parentName: \"li\"\n  }, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {}), \"docker buildx build --platform linux/amd64,linux/arm64 -t adri/test:arm-test -f etc/php7-fpm/Dockerfile --push .\\n\")))), mdx(\"h3\", null, \"Sources\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://www.docker.com/blog/multi-arch-images/\",\n    \"target\": \"_blank\",\n    \"rel\": \"nofollow noopener noreferrer\"\n  }), \"Building Multi-Arch Images for Arm and x86 with Docker Desktop\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://aws.amazon.com/blogs/compute/improving-performance-of-php-for-arm64-and-impact-on-amazon-ec2-m6g-instances/\",\n    \"target\": \"_blank\",\n    \"rel\": \"nofollow noopener noreferrer\"\n  }), \"Improving performance of PHP for Arm64 and impact on AWS Graviton2 based EC2 instances\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://www.androidcentral.com/what-arm-cpu\",\n    \"target\": \"_blank\",\n    \"rel\": \"nofollow noopener noreferrer\"\n  }), \"What is ARM\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://cs.stanford.edu/people/eroberts/courses/soco/projects/2000-01/risc/risccisc/\",\n    \"target\": \"_blank\",\n    \"rel\": \"nofollow noopener noreferrer\"\n  }), \"RISC vs CISC\"))), mdx(\"p\", null, mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"/notes/published\"\n  }), \"#published\"), \" \"));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"Amazon has published a blog post  Improving performance of PHP for Arm64 and impact on AWS Graviton2 based EC2 instances  that shows 2â€¦","timeToRead":2}}},"pageContext":{"slug":"run-php-on-arm-based-aws-eks"}},"staticQueryHashes":["318001574","3787687951"]}