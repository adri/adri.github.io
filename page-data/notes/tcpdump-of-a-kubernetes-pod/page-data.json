{"componentChunkName":"component---plugins-gatsby-theme-brain-src-templates-brain-js","path":"/notes/tcpdump-of-a-kubernetes-pod/","result":{"data":{"brainNote":{"slug":"tcpdump-of-a-kubernetes-pod","title":"Tcpdump of a Kubernetes pod","inboundReferenceNotes":[{"title":"Troubleshoot performance","slug":"troubleshoot-performance"}],"inboundReferences":["troubleshoot-performance"],"childMdx":{"body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"There are tools like \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"kubectl debug\"), \" that can start a tcpdump, however I wasn't able to start the tool for multiple pods at the same time. Becauase of an error that happend only sometimes, I needed to get a tcpdump on multiple pods of a deployment.\"), mdx(\"p\", null, \"Example call:\", mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"tcpdump -w /proc/1/root/tmp/trace.pcap -i eth0 -nn \\\"src 172.31.80.74 or dst 172.31.80.74\\\"\")), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"-nn\"), \" doesn't  resolve IPs or ports\", mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"\\\"src 172.31.80.74 or dst 172.31.80.74\\\"\"), \" limits Redis communication\"), mdx(\"p\", null, \"This script gets the host and the container ID of a given pod and then connects to that host, runs tcpdump on it and when stopped using ctrl + c it downloads and deletes the pcap file.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"#!/usr/bin/env bash\\n# Usage:\\n# bash tcpdump-pod.sh name-of-pod\\n\\nremote() {\\n  ssh -i ~/.ssh/k8s_prod_id_rsa -oStrictHostKeyChecking=no -o IdentitiesOnly=yes -o ServerAliveInterval=60 -o ProxyCommand=\\\"ssh -W %h:%p -o ServerAliveInterval=60 server\\\" ec2-user@$1 $2\\n}\\n\\nremote_cp() {\\n  scp -i ~/.ssh/k8s_prod_id_rsa -o IdentitiesOnly=yes -o ProxyCommand=\\\"ssh -W %h:%p server\\\" ec2-user@$1:$2 $2\\n}\\n\\ndownload_pcap() {\\n  remote_cp $hostIP $pod.pcap\\n  remote $hostIP \\\"rm $pod.pcap\\\"\\n\\n  echo \\\"Downloaded to $pod.pcap and removed from server\\\"\\n\\n  exit 0;\\n}\\ntrap download_pcap INT\\n\\nset -ex\\npod=$1\\nhostIP=$(kubectl get pod $pod -o json | jq -r .status.hostIP)\\ncontainerID=$(kubectl get pod $pod -o json | jq -r '.status.containerStatuses[] | select(.name == \\\"php\\\") | .containerID' | sed 's/^docker:\\\\/\\\\///g')\\ninterfaceID=$(remote $hostIP \\\"docker exec $containerID /bin/bash -c 'cat /sys/class/net/eth0/iflink'\\\")\\neniID=$(remote $hostIP \\\"sudo ip link |grep ^$interfaceID: | sed -nE 's/[0-9]+: (.*)@.*/\\\\1/p'\\\")\\nremote $hostIP \\\"sudo yum install tcpdump -y\\\"\\nremote $hostIP \\\"sudo rm -fr $pod.pcap || true\\\"\\nremote $hostIP \\\"sudo tcpdump -nn 'src 172.31.80.74 or dst 172.31.80.74' -w $pod.pcap -i $eniID\\\"\\n\")), mdx(\"p\", null, mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"/notes/published\"\n  }), \"#published\"), \" \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"/notes/kubernetes\"\n  }), \"#kubernetes\"), \" \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"/notes/tool\"\n  }), \"#tool\"), \" \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"/notes/script\"\n  }), \"#script\"), \" \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"/notes/performance\"\n  }), \"#performance\")));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"There are tools like  kubectl debug  that can start a tcpdump, however I wasn't able to start the tool for multiple pods at the same timeâ€¦","timeToRead":1}}},"pageContext":{"slug":"tcpdump-of-a-kubernetes-pod"}},"staticQueryHashes":["318001574","3787687951"]}